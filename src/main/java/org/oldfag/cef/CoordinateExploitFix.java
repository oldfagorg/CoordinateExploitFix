package org.oldfag.cef;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.wrappers.BlockPosition;
import com.comphenix.protocol.wrappers.EnumWrappers;
import org.bukkit.plugin.java.JavaPlugin;
import org.oldfag.cef.packetwrapper.WrapperPlayClientBlockDig;

public final class CoordinateExploitFix extends JavaPlugin {
	@Override
	public void onEnable() {
		ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(this, ListenerPriority.NORMAL, PacketType.Play.Client.BLOCK_DIG) {
			@Override
			public void onPacketReceiving(PacketEvent event) {
				if (event.getPlayer() == null) {
					return;
				}

				final PacketContainer packet = event.getPacket();
				final WrapperPlayClientBlockDig wrappedPacket = new WrapperPlayClientBlockDig(packet);
				final EnumWrappers.PlayerDigType type = wrappedPacket.getStatus();

				if (type.equals(EnumWrappers.PlayerDigType.START_DESTROY_BLOCK) || type.equals(EnumWrappers.PlayerDigType.ABORT_DESTROY_BLOCK) || type.equals(EnumWrappers.PlayerDigType.STOP_DESTROY_BLOCK)) {
					final BlockPosition blockPos = wrappedPacket.getLocation();
					final double distance = event.getPlayer().getLocation().distance(blockPos.toLocation(event.getPlayer().getWorld()));

					if (distance > 64) {
						event.setCancelled(true);
					}
				}
			}
		});
	}
}
